name: Deploy to VPS

on:
  push:
    branches:
      - dev-1.0
      - prod-1.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy to VPS
        run: |
          echo "Branch: $GITHUB_REF_NAME"

          # Set the directory on VPS
          VPS_DIR="/root/development"
          FILE_NAME="dev-compose.yml"

          # Determine which service to rebuild
          if [ "$GITHUB_REF_NAME" == "dev-1.0" ]; then
            VPS_DIR="/root/development"
            FILE_NAME="dev-compose.yml"
          elif [ "$GITHUB_REF_NAME" == "prod-1.0" ]; then
            VPS_DIR="/root/production"
            FILE_NAME="prod-compose.yml"
          else
            echo "No matching branch for deployment"
            exit 0
          fi

          ssh -o StrictHostKeyChecking=no user@your_vps_ip << EOF
            echo "Deploying $SERVICE..."
            cd $VPS_DIR
            docker compose -f $FILE_NAME build backend
            docker compose -f $FILE_NAME up -d backend
            echo "Restarting Nginx..."
            docker exec -i reverse-proxy nginx -s reload
            echo "Deployment complete."
          EOF
